#!/bin/bash

# --------------------- CONFIG BEGIN ---------------------

# The location of the saves folder on your cloud storage.
destinationFolder=/Games/Batocera

# Waiting time between two backups in seconds. The below configuration means that the service will do a backup every minute.
waitSeconds=60

# ---------------------- CONFIG END ----------------------

runFile=/var/run/backup-service
logFile=/var/log/backup-service.log

manual() {
    echo "> CONFIG sync" ------------------------------------------------------------------------------------
    rclone sync /userdata/system/batocera.conf backup:${destinationFolder}/system --progress

    echo "> SAVES sync" -------------------------------------------------------------------------------------
    rclone sync /userdata/saves backup:${destinationFolder}/saves --exclude "flatpak/**" --progress

    echo "> ROMS sync" --------------------------------------------------------------------------------------
    rclone sync /userdata/roms backup:${destinationFolder}/roms --exclude "flatpak/**" --progress

    echo "> BIOS sync" --------------------------------------------------------------------------------------
    rclone sync /userdata/bios backup:${destinationFolder}/bios --progress
}

start() {
    touch ${runFile}
    while test -e ${runFile}; do
        sleep ${waitSeconds}
        # TODO: limit log file size
        rclone sync /userdata/saves backup:${destinationFolder}/saves --exclude "flatpak/**" --log-file ${logFile} --log-level INFO
    done
}

stop() {
    rm -f ${runFile}
}

status() {
    if test -e ${runFile}; then
        echo "Backup service is running. You can find it's logs in: ${logFile}"
    else
        echo "Backup service is not running."
    fi
}

case "$1" in
    manual)
        manual
        ;;
    start)
        start &
        ;;
    stop)
        stop
        ;;
    status)
        status
        ;;
    *)
        echo "Usage: https://gitlab.com/peterbozso/batocera-scripts#backup"
        ;;
esac
