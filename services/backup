#!/bin/bash

# --------------------- CONFIG BEGIN ---------------------

# The location of the saves folder on your cloud storage.
destinationFolder=/Games/Batocera

# Waiting time between two backups in seconds. The below configuration means that the service will do a backup every minute.
waitSeconds=10 # TODO: change it back to 60

# If set to true, logs from all runs of the service are preserved. If set to false, only logs since the last start of the service are kept.
keepLogs=false

# ---------------------- CONFIG END ----------------------

runFile=/var/run/backup-service
logFile=/var/log/backup-service.log

manual() {
    echo "> CONFIG sync" ------------------------------------------------------------------------------------
    rclone sync /userdata/system/batocera.conf backup:${destinationFolder}/system --progress

    echo "> SAVES sync" -------------------------------------------------------------------------------------
    rclone sync /userdata/saves backup:${destinationFolder}/saves --exclude "flatpak/**" --progress

    echo "> ROMS sync" --------------------------------------------------------------------------------------
    rclone sync /userdata/roms backup:${destinationFolder}/roms --exclude "flatpak/**" --progress

    echo "> BIOS sync" --------------------------------------------------------------------------------------
    rclone sync /userdata/bios backup:${destinationFolder}/bios --progress
}

# TODO: fix start at system startup.
# For some reason it fails with these errors:
# NOTICE: Config file "/.config/rclone/rclone.conf" not found - using defaults
# Failed to create file system for "backup:/Games/Batocera/saves": didn't find section in config file
start() {
    touch ${runFile}

    if [ "$keepLogs" = false ]; then
        rm -f ${logFile}
    fi

    timeStamp="$(date)"
    echo -e "\n--- SERVICE START - [${timeStamp}] ---\n" >>${logFile}

    while test -e ${runFile}; do
        sleep ${waitSeconds}
        rclone sync /userdata/saves backup:${destinationFolder}/saves --exclude "flatpak/**" --log-file ${logFile} --log-level INFO
    done
}

stop() {
    rm -f ${runFile}
}

status() {
    if test -e ${runFile}; then
        echo "Backup service is running. Logs: ${logFile}"
    else
        echo "Backup service is not running."
    fi
}

case "$1" in
    manual)
        manual
        ;;
    start)
        start &
        ;;
    stop)
        stop
        ;;
    status)
        status
        ;;
    *)
        echo "Usage: https://gitlab.com/peterbozso/batocera-scripts#backup"
        ;;
esac
