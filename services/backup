#!/bin/bash

# --------------------- CONFIG BEGIN ---------------------

# The location of the saves folder on your cloud storage.
destinationFolder=/Games/Batocera/saves

# Waiting time between two backups in seconds. The below configuration means that the service will do a backup every minute.
waitSeconds=30 # TODO: change it back to 60

# ---------------------- CONFIG END ----------------------

runFile=/var/run/backup
logFile=/var/log/backup.log

do_sync() {
    rm -f ${logFile}
    rclone sync /userdata/saves backup:${destinationFolder} --log-file ${logFile} --log-level INFO --stats 1s

    # TODO: Make is possible to sync other stuff.
    # Examples:
    #     /userdata/system/batocera.conf
    #     /userdata/bios
    #     /userdata/roms
}

start() {
    touch ${runFile}
    while test -e ${runFile}; do
        echo "0" >${runFile}
        do_sync
        echo ${waitSeconds} >${runFile}
        sleep ${waitSeconds}
    done
}

stop() {
    rm -f ${runFile}
}

status() {
    if test -e ${runFile}; then
        remainingSeconds=$(<${runFile})

        if [ ${remainingSeconds} -eq "0" ]; then
            cat ${logFile}
        else
            echo "There's no backup in progress."
        fi
    else
        echo "Service is not started."
    fi
}

case "$1" in
    manual)
        do_sync
        ;;
    start)
        start &
        ;;
    stop)
        stop
        ;;
    status)
        status
        ;;
    *)
        echo "Usage: https://gitlab.com/peterbozso/batocera-scripts#backup"
        ;;
esac
